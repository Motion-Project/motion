name: CI

on:
  push:
    paths-ignore:
      - .github/ISSUE_TEMPLATE/**
      - doc/**
      - man/**
      - '**/LICENCE'
      - '**/.gitignore'
      - '**.md'
  pull_request:
    paths-ignore:
      - .github/ISSUE_TEMPLATE/**
      - doc/**
      - man/**
      - '**/LICENCE'
      - '**/.gitignore'
      - '**.md'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  frontend:
    name: Frontend Build & Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout source
        uses: actions/checkout@main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Build frontend
        run: npm run build

      - name: Verify build artifacts
        run: |
          test -f ../data/webui/index.html || { echo "index.html not found"; exit 1; }
          test -d ../data/webui/assets || { echo "assets directory not found"; exit 1; }
          echo "âœ… Frontend build artifacts verified"

  backend:
    name: Backend Build (${{ matrix.cxx }}, ${{ matrix.libc }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        cxx: [g++, clang++]
        libc: [glibc, musl]
        include:
          - cxx: g++
            cc: gcc
          - cxx: clang++
            cc: clang
          - libc: glibc
            shell: bash
          - libc: musl
            shell: alpine.sh {0}

    defaults:
      run:
        shell: ${{ matrix.shell }}

    steps:
      - name: Set up Ubuntu
        if: matrix.libc == 'glibc'
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool autopoint autoconf-archive pkgconf gettext libcamera-dev libopencv-dev libavcodec-dev libavdevice-dev libavformat-dev libavutil-dev libswscale-dev libwebp-dev libmicrohttpd-dev libmariadb-dev libasound2-dev libpulse-dev libfftw3-dev

      - name: Set up Alpine
        if: matrix.libc == 'musl'
        uses: jirutka/setup-alpine@master
        with:
          branch: edge
          packages: >
            build-base
            clang
            file
            autoconf
            autoconf-archive
            automake
            libtool
            bash
            gettext-dev
            libzip-dev
            jpeg-dev
            v4l-utils-libs
            libcamera-dev
            opencv-dev
            openexr-dev
            imath-dev
            ffmpeg-dev
            libmicrohttpd-dev
            sqlite-dev
            mariadb-dev
            alsa-lib-dev
            pulseaudio-dev
            fftw-dev

      - name: Checkout source
        uses: actions/checkout@main

      - name: Configure build
        run: |
          autoreconf -fiv
          # Pass LIBS directly to configure for Alpine OpenEXR/Imath transitive dependency issue
          # OpenCV's imgcodecs requires OpenEXR (Imf) and Imath but pkg-config doesn't pull them in
          CONFIG_SHELL=/bin/bash ./configure CC=${{ matrix.cc }} CXX=${{ matrix.cxx }} ${{ matrix.libc == 'musl' && 'LIBS="-lOpenEXR -lImath"' || '' }}

      - name: Build target
        run: |
          ${{ matrix.CXX }} --version
          make -j $(($(nproc)+1))

      - name: Run artifact
        run: |
          file ./src/motion
          ./src/motion -h || true
