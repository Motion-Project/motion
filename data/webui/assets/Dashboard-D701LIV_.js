import{r as a,j as e,u as W,a as O,t as Y,b as q,c as Q,d as G,e as H,f as z,g as V}from"./index-DCzq8GhF.js";import{u as U,p as $,a as K,C as J,F as y,b as L,c as F,A as X,d as Z,e as B}from"./parameterMappings-CUuSfEkB.js";function ee({isOpen:n,onClose:i,sheetRef:o,closeThreshold:m=.3}){const[c,d]=a.useState(!1),[g,b]=a.useState(0),v=a.useRef(0),h=a.useRef(0),r=a.useRef(0),l=a.useRef(0),j=a.useRef(0),x=a.useCallback(u=>{d(!0),v.current=u,h.current=u,j.current=u,l.current=Date.now(),r.current=0},[]),p=a.useCallback(u=>{if(!c)return;const k=Date.now(),T=k-l.current,s=u-j.current;T>0&&(r.current=s/T),l.current=k,j.current=u,h.current=u;const f=Math.max(0,u-v.current);b(f)},[c]),N=a.useCallback(()=>{if(!c)return;d(!1);const u=o.current?.offsetHeight||400;(g>u*m||r.current>.5)&&i(),b(0),r.current=0},[c,g,i,m,o]),w=a.useCallback(u=>{const k=u.touches[0],T=o.current?.getBoundingClientRect().top||0;k.clientY-T<=60&&x(k.clientY)},[x,o]),M=a.useCallback(u=>{c&&(u.preventDefault(),p(u.touches[0].clientY))},[c,p]),t=a.useCallback(()=>{N()},[N]),C=a.useCallback(u=>{const k=o.current?.getBoundingClientRect().top||0;if(u.clientY-k<=60){x(u.clientY);const s=_=>{p(_.clientY)},f=()=>{N(),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",f)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",f)}},[x,p,N,o]),S=n?c?`translateY(${g}px)`:"translateY(0)":"translateY(100%)";return{handlers:{onTouchStart:w,onTouchMove:M,onTouchEnd:t,onMouseDown:C},style:{transform:S},state:{isDragging:c,dragOffset:g}}}function A({isOpen:n,onClose:i,title:o,children:m,headerRight:c}){const d=a.useRef(null),g=a.useRef(null),b=a.useRef(null),{handlers:v,style:h}=ee({isOpen:n,onClose:i,sheetRef:d});a.useEffect(()=>{if(!n)return;const l=x=>{x.key==="Escape"&&i()},j=x=>{if(x.key!=="Tab"||!d.current)return;const p=d.current.querySelectorAll('button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'),N=p[0],w=p[p.length-1];N&&(x.shiftKey?document.activeElement===N&&(x.preventDefault(),w?.focus()):document.activeElement===w&&(x.preventDefault(),N?.focus()))};return document.addEventListener("keydown",l),document.addEventListener("keydown",j),()=>{document.removeEventListener("keydown",l),document.removeEventListener("keydown",j)}},[n,i]),a.useEffect(()=>(n?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[n]),a.useEffect(()=>{n?(b.current=document.activeElement,setTimeout(()=>{if(d.current){const l=d.current.querySelectorAll('button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])');l.length>0&&l[0].focus()}},100)):b.current&&b.current.focus()},[n]);const r=a.useCallback(l=>{l.target===l.currentTarget&&i()},[i]);return n?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-[100]",onClick:r,"aria-hidden":"true"}),e.jsxs("div",{ref:d,className:"fixed bottom-0 left-0 right-0 z-[101] bg-surface/95 backdrop-blur-sm rounded-t-2xl shadow-2xl transition-transform duration-300 ease-out border-t border-surface-elevated",style:{maxHeight:"45vh",transform:h.transform},role:"dialog","aria-modal":"true","aria-label":o,...v,children:[e.jsx("div",{className:"flex justify-center pt-3 pb-2 cursor-grab active:cursor-grabbing touch-none",children:e.jsx("div",{className:"w-12 h-1.5 bg-gray-500 rounded-full"})}),e.jsxs("div",{className:"flex items-center justify-between px-4 pb-3 border-b border-surface-elevated",children:[e.jsx("h2",{className:"text-lg font-semibold",children:o}),e.jsxs("div",{className:"flex items-center gap-3",children:[c,e.jsx("button",{type:"button",onClick:i,className:"p-2 hover:bg-surface-elevated rounded-full transition-colors","aria-label":"Close",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}),e.jsx("div",{ref:g,className:"overflow-y-auto overscroll-contain px-4 py-4",style:{maxHeight:"calc(45vh - 80px)"},children:m})]})]}):null}function E({title:n,defaultOpen:i=!0,children:o}){const[m,c]=a.useState(i);return e.jsxs("div",{className:"mb-4",children:[e.jsxs("button",{type:"button",className:"flex items-center justify-between w-full py-2 text-left",onClick:()=>c(!m),children:[e.jsx("span",{className:"font-medium text-sm",children:n}),e.jsx("svg",{className:`w-4 h-4 transition-transform ${m?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),m&&e.jsx("div",{className:"pt-2",children:o})]})}function D({cameraId:n,config:i}){const{mutate:o,isPending:m}=W(),[c,d]=a.useState(null),[g,b]=a.useState({}),v=a.useRef({}),{data:h}=U(n);a.useEffect(()=>()=>{Object.values(v.current).forEach(clearTimeout)},[]),a.useEffect(()=>{b({})},[i]);const r=a.useCallback((t,C="")=>t in g?g[t]:i[t]?.value??C,[i,g]);a.useEffect(()=>{Object.values(v.current).forEach(clearTimeout),v.current={}},[n]);const l=a.useCallback((t,C)=>{b(u=>({...u,[t]:C})),v.current[t]&&clearTimeout(v.current[t]);const S=n;v.current[t]=setTimeout(()=>{o({camId:S,changes:{[t]:C}},{onSuccess:()=>{d(t),setTimeout(()=>d(null),1e3)}})},300)},[n,o]),j=a.useCallback((t,C)=>{b(S=>({...S,[t]:C})),o({camId:n,changes:{[t]:C}},{onSuccess:()=>{d(t),setTimeout(()=>d(null),1e3)}})},[n,o]),x=Number(r("width",640)),p=Number(r("height",480)),N=Number(r("threshold",1500)),w=$(N,x,p),M=a.useCallback(t=>{const C=K(t,x,p);l("threshold",C)},[x,p,l]);return e.jsxs("div",{className:"space-y-2",children:[e.jsx(J,{cameraId:n,readOnly:!0}),e.jsxs(E,{title:"Stream",defaultOpen:!1,children:[e.jsx(y,{label:"Quality",value:Number(r("stream_quality",50)),onChange:t=>l("stream_quality",t),min:1,max:100,unit:"%",helpText:"JPEG compression quality"}),e.jsx(y,{label:"Max Framerate",value:Number(r("stream_maxrate",15)),onChange:t=>l("stream_maxrate",t),min:1,max:30,unit:" fps",helpText:"Maximum stream framerate"})]}),e.jsxs(E,{title:"Image",defaultOpen:!1,children:[e.jsx(y,{label:"Brightness",value:Number(r("libcam_brightness",0)),onChange:t=>l("libcam_brightness",t),min:-1,max:1,step:.1,helpText:"Brightness adjustment"}),e.jsx(y,{label:"Contrast",value:Number(r("libcam_contrast",1)),onChange:t=>l("libcam_contrast",t),min:0,max:32,step:.5,helpText:"Contrast adjustment"}),e.jsx(y,{label:"Gain (ISO)",value:Number(r("libcam_gain",1)),onChange:t=>l("libcam_gain",t),min:0,max:10,step:.1,helpText:"Analog gain (0=auto, 1.0-10.0) (Gain 1.0 ~ ISO 100)"}),e.jsx(L,{label:"Auto White Balance",value:!!r("libcam_awb_enable",!0),onChange:t=>j("libcam_awb_enable",t),helpText:"Enable automatic white balance"}),!!r("libcam_awb_enable",!0)&&e.jsxs(e.Fragment,{children:[e.jsx(F,{label:"AWB Mode",value:String(r("libcam_awb_mode",0)),onChange:t=>j("libcam_awb_mode",Number(t)),options:X.map(t=>({value:String(t.value),label:t.label})),helpText:"White balance mode"}),h?.AwbLocked!==!1&&e.jsx(L,{label:"Lock AWB",value:!!r("libcam_awb_locked",!1),onChange:t=>j("libcam_awb_locked",t),helpText:"Lock white balance settings"})]}),!r("libcam_awb_enable",!0)&&e.jsxs(e.Fragment,{children:[h?.ColourTemperature!==!1&&e.jsx(y,{label:"Color Temperature",value:Number(r("libcam_colour_temp",0)),onChange:t=>l("libcam_colour_temp",t),min:0,max:1e4,step:100,unit:" K",helpText:"Manual color temperature in Kelvin (0-10000)"}),e.jsx(y,{label:"Red Gain",value:Number(r("libcam_colour_gain_r",1)),onChange:t=>l("libcam_colour_gain_r",t),min:0,max:8,step:.1,helpText:"Red color gain (0.0-8.0)"}),e.jsx(y,{label:"Blue Gain",value:Number(r("libcam_colour_gain_b",1)),onChange:t=>l("libcam_colour_gain_b",t),min:0,max:8,step:.1,helpText:"Blue color gain (0.0-8.0)"}),h?.ColourTemperature===!1&&e.jsxs("div",{className:"text-xs text-gray-400 bg-surface-elevated p-3 rounded",children:[e.jsx("strong",{children:"Note:"})," Color Temperature control is not available on this camera. NoIR cameras and some other sensors don't support this feature. Use Red/Blue Gain for manual white balance."]})]}),h?.AfMode&&e.jsxs(e.Fragment,{children:[e.jsx(F,{label:"Autofocus Mode",value:String(r("libcam_af_mode",0)),onChange:t=>j("libcam_af_mode",Number(t)),options:Z.map(t=>({value:String(t.value),label:t.label})),helpText:"Focus control mode"}),Number(r("libcam_af_mode",0))===0&&h?.LensPosition&&e.jsx(y,{label:"Lens Position",value:Number(r("libcam_lens_position",0)),onChange:t=>l("libcam_lens_position",t),min:0,max:15,step:.5,unit:" dioptres",helpText:"Manual focus position (0.0-15.0 dioptres)"})]}),!h?.AfMode&&h?.LensPosition&&e.jsx(y,{label:"Lens Position",value:Number(r("libcam_lens_position",0)),onChange:t=>l("libcam_lens_position",t),min:0,max:15,step:.5,unit:" dioptres",helpText:"Manual focus position (0.0-15.0 dioptres)"})]}),e.jsxs(E,{title:"Detection",defaultOpen:!1,children:[e.jsx(y,{label:"Threshold",value:w,onChange:M,min:0,max:20,step:.1,unit:"%",helpText:"Motion sensitivity (higher = less sensitive)"}),e.jsx(y,{label:"Noise Level",value:Number(r("noise_level",32)),onChange:t=>l("noise_level",t),min:1,max:255,helpText:"Noise tolerance"}),e.jsx(L,{label:"Auto-tune Noise",value:!!r("noise_tune",!1),onChange:t=>j("noise_tune",t),helpText:"Automatically adjust noise level"})]}),m&&e.jsx("div",{className:"text-center text-sm text-gray-400 py-2",children:"Applying..."}),c&&!m&&e.jsx("div",{className:"text-center text-sm text-green-400 py-2",children:"Applied!"})]})}function R({cameraId:n}){const[i,o]=a.useState(!1),m=c=>{c.stopPropagation();const d=document.querySelector(`[data-camera-id="${n}"]`);d&&(i?document.exitFullscreen&&document.exitFullscreen():d.requestFullscreen&&d.requestFullscreen())};return a.useEffect(()=>{const c=()=>{o(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",c),()=>{document.removeEventListener("fullscreenchange",c)}},[]),e.jsx("button",{type:"button",onClick:m,className:"p-1.5 hover:bg-surface rounded-full transition-colors","aria-label":"Toggle fullscreen",title:"Toggle fullscreen",children:e.jsx("svg",{className:"w-5 h-5 text-gray-400 hover:text-gray-200",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:i?e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5m0-4.5l5.25 5.25"}):e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"})})})}function I({cameraId:n,onClick:i}){return e.jsx("button",{type:"button",onClick:o=>{o.stopPropagation(),i(n)},className:"p-1.5 hover:bg-surface rounded-full transition-colors","aria-label":"Quick settings",title:"Quick settings",children:e.jsxs("svg",{className:"w-5 h-5 text-gray-400 hover:text-gray-200",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})]})})}function P({cameraId:n}){const[i,o]=a.useState(!1),{addToast:m}=O(),c=async d=>{if(d.stopPropagation(),!i){o(!0);try{await Y(n),m("Snapshot captured","success")}catch(g){m(g instanceof Error?g.message:"Failed to capture snapshot","error")}finally{o(!1)}}};return e.jsx("button",{type:"button",onClick:c,disabled:i,className:"p-1.5 hover:bg-surface rounded-full transition-colors disabled:opacity-50","aria-label":"Take snapshot",title:"Take snapshot",children:i?e.jsxs("svg",{className:"w-5 h-5 text-gray-400 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):e.jsxs("svg",{className:"w-5 h-5 text-gray-400 hover:text-gray-200",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 13a3 3 0 11-6 0 3 3 0 016 0z"})]})})}function ae(){const{data:n,isLoading:i,error:o}=q(),{role:m,isAuthenticated:c,authRequired:d}=Q(),{data:g}=G({enabled:!d||c}),[b,v]=a.useState(!1),[h,r]=a.useState(null),[l,j]=a.useState({}),x=s=>g?.find(f=>f.id===s)?.fps??0,p=s=>l[s]??0,N=s=>f=>{j(_=>({..._,[s]:f}))},{data:w}=H({queryKey:["config"],queryFn:async()=>{const s=await z("/0/api/config");return s.csrf_token&&V(s.csrf_token),s},enabled:b,staleTime:3e4}),M=s=>{r(s),v(!0)},t=()=>{v(!1)},C=n?.find(s=>s.id===h),S=C?`Quick Settings - ${C.name}`:"Quick Settings",u=a.useMemo(()=>{if(!w||!h)return{};const s=w.configuration?.default||{},f=w.configuration?.[`cam${h}`]||{};return{...s,...f}},[w,h]);if(i)return e.jsxs("div",{className:"p-4 sm:p-6",children:[e.jsx("h2",{className:"text-2xl sm:text-3xl font-bold mb-4 sm:mb-6",children:"Camera Dashboard"}),e.jsx("div",{className:"flex flex-col items-center gap-6",children:[1].map(s=>e.jsxs("div",{className:"bg-surface-elevated rounded-lg p-4 animate-pulse w-full max-w-4xl",children:[e.jsx("div",{className:"h-6 bg-surface rounded w-1/3 mb-4"}),e.jsx("div",{className:"aspect-video bg-surface rounded"})]},s))})]});if(o)return e.jsxs("div",{className:"p-4 sm:p-6",children:[e.jsx("h2",{className:"text-2xl sm:text-3xl font-bold mb-4 sm:mb-6",children:"Camera Dashboard"}),e.jsxs("div",{className:"bg-danger/10 border border-danger rounded-lg p-4 max-w-2xl mx-auto",children:[e.jsxs("p",{className:"text-danger",children:["Failed to load cameras: ",o instanceof Error?o.message:"Unknown error"]}),e.jsx("button",{className:"mt-2 text-sm text-primary hover:underline",onClick:()=>window.location.reload(),children:"Retry"})]})]});if(!n||n.length===0)return e.jsxs("div",{className:"p-4 sm:p-6",children:[e.jsx("h2",{className:"text-2xl sm:text-3xl font-bold mb-4 sm:mb-6",children:"Camera Dashboard"}),e.jsxs("div",{className:"bg-surface-elevated rounded-lg p-8 text-center max-w-2xl mx-auto",children:[e.jsx("svg",{className:"w-16 h-16 mx-auto text-gray-600 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})}),e.jsx("p",{className:"text-gray-400 text-lg",children:"No cameras configured"}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Add cameras in Motion's configuration file"})]})]});const k=n.length;if(k===1){const s=n[0],f=x(s.id),_=p(s.id);return e.jsxs("div",{className:"p-4 sm:p-6",children:[e.jsx("div",{className:"max-w-5xl mx-auto",children:e.jsxs("div",{className:"bg-surface-elevated rounded-lg overflow-hidden shadow-lg","data-camera-id":s.id,children:[e.jsxs("div",{className:"px-4 py-3 border-b border-surface flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),e.jsx("h3",{className:"font-medium",children:s.name})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[s.width&&s.height&&e.jsxs("span",{className:"text-xs text-gray-500",children:[s.width,"x",s.height]}),(_>0||f>0)&&e.jsxs("span",{className:"text-xs font-mono text-gray-400 cursor-help",title:"streaming / capture frame rate",children:[_," / ",f," fps"]}),m==="admin"&&e.jsx(P,{cameraId:s.id}),e.jsx(R,{cameraId:s.id}),m==="admin"&&e.jsx(I,{cameraId:s.id,onClick:M})]})]}),e.jsx(B,{cameraId:s.id,onStreamFpsChange:N(s.id)})]})}),e.jsx(A,{isOpen:b,onClose:t,title:S,children:h&&e.jsx(D,{cameraId:h,config:u})})]})}const T=()=>k===2?"grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6":k<=4?"grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6":"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 sm:gap-6";return e.jsxs("div",{className:"p-4 sm:p-6",children:[e.jsxs("h2",{className:"text-2xl sm:text-3xl font-bold mb-4 sm:mb-6",children:["Cameras (",k,")"]}),e.jsx("div",{className:T(),children:n.map(s=>{const f=x(s.id),_=p(s.id);return e.jsxs("div",{className:"bg-surface-elevated rounded-lg overflow-hidden shadow-lg","data-camera-id":s.id,children:[e.jsxs("div",{className:"px-4 py-3 border-b border-surface flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),e.jsx("h3",{className:"font-medium text-sm sm:text-base",children:s.name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[s.width&&s.height&&e.jsxs("span",{className:"text-xs text-gray-500",children:[s.width,"x",s.height]}),(_>0||f>0)&&e.jsxs("span",{className:"text-xs font-mono text-gray-400 cursor-help",title:"streaming / capture frame rate",children:[_," / ",f," fps"]}),m==="admin"&&e.jsx(P,{cameraId:s.id}),e.jsx(R,{cameraId:s.id}),m==="admin"&&e.jsx(I,{cameraId:s.id,onClick:M})]})]}),e.jsx(B,{cameraId:s.id,onStreamFpsChange:N(s.id)})]},s.id)})}),e.jsx(A,{isOpen:b,onClose:t,title:S,children:h&&e.jsx(D,{cameraId:h,config:u})})]})}export{ae as Dashboard};
