import{j as e,a as ie,c as ne,k as re,r as n,q as R,b as oe,s as ce,v as de,w as ue,x as me,y as xe,z as pe,m as he}from"./index-tiawrtsp.js";function O({offset:a,limit:c,total:r,onPageChange:f,context:l}){const v=Math.floor(a/c)+1,i=Math.ceil(r/c),b=r===0?0:a+1,t=Math.min(a+c,r),x=a>0,d=a+c<r;return e.jsxs("div",{className:"flex items-center justify-between py-3 px-1",children:[e.jsxs("span",{className:"text-sm text-gray-400",children:["Displaying ",b,"-",t," of ",r,l&&e.jsxs("span",{className:"text-gray-500",children:[" ",l]})]}),i>1&&e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("button",{onClick:()=>f(Math.max(0,a-c)),disabled:!x,className:"px-3 py-1 bg-surface-elevated hover:bg-surface rounded disabled:opacity-50 disabled:cursor-not-allowed text-sm transition-colors","aria-label":"Previous page",children:"◀ Previous"}),e.jsxs("span",{className:"px-3 py-1 text-sm text-gray-400",children:["Page ",v," of ",i]}),e.jsx("button",{onClick:()=>f(a+c),disabled:!d,className:"px-3 py-1 bg-surface-elevated hover:bg-surface rounded disabled:opacity-50 disabled:cursor-not-allowed text-sm transition-colors","aria-label":"Next page",children:"Next ▶"})]})]})}function k(a){const c=he();if(!c)return a;const r=a.includes("?")?"&":"?";return`${a}${r}token=${encodeURIComponent(c)}`}const g=100;function fe(a,c){if(!a||a.length!==8)return null;const r=parseInt(a.substring(0,4),10),f=parseInt(a.substring(4,6),10)-1,l=parseInt(a.substring(6,8),10);if(isNaN(r)||isNaN(f)||isNaN(l))return null;let v=0,i=0,b=0;if(c){const x=c.split(":");x.length>=2&&(v=parseInt(x[0],10)||0,i=parseInt(x[1],10)||0,b=parseInt(x[2],10)||0)}const t=new Date(r,f,l,v,i,b);return isNaN(t.getTime())?null:t}function be(){const{addToast:a}=ie(),{role:c}=ne(),r=re(),f=c==="admin",[l,v]=n.useState(1),[i,b]=n.useState("pictures"),[t,x]=n.useState("all"),[d,P]=n.useState(""),[Y,y]=n.useState(0),[o,w]=n.useState(null),[p,C]=n.useState(null),[j,A]=n.useState(null),N=Y*g;n.useEffect(()=>{y(0)},[l,i,d]),n.useEffect(()=>{t==="all"&&P("")},[t]),n.useEffect(()=>{t==="all"&&(r.invalidateQueries({queryKey:R.movies(l)}),r.invalidateQueries({queryKey:R.pictures(l)}))},[t,l,r]),n.useEffect(()=>{t==="folders"&&r.invalidateQueries({predicate:s=>Array.isArray(s.queryKey)&&s.queryKey[0]==="media-folders"&&s.queryKey[1]===l})},[t,d,l,r]);const{data:Z}=oe(),{data:B,isLoading:J}=ce(l,N,g,null,{enabled:t==="all"&&i==="pictures"}),{data:E,isLoading:X}=de(l,N,g,null,{enabled:t==="all"&&i==="movies"}),{data:u,isLoading:ee}=ue(l,d,N,g,{enabled:t==="folders"}),$=me(),L=xe(),F=pe(),T=t==="folders"?ee:i==="pictures"?J:X,q=t==="folders"?u?.files??[]:i==="pictures"?B?.pictures??[]:E?.movies??[],D=t==="folders"?u?.total_files??0:i==="pictures"?B?.total_count??0:E?.total_count??0,I=s=>s<1024?`${s} B`:s<1024*1024?`${(s/1024).toFixed(1)} KB`:s<1024*1024*1024?`${(s/(1024*1024)).toFixed(1)} MB`:`${(s/(1024*1024*1024)).toFixed(1)} GB`,K=(s,m)=>{const h=fe(s,m);return h?h.toLocaleDateString()+" "+h.toLocaleTimeString():"Unknown date"},se=n.useCallback((s,m)=>{m.stopPropagation(),C(s)},[]),te=n.useCallback(async()=>{if(p)try{const s="type"in p?p.type:i;s==="picture"||s==="pictures"?await $.mutateAsync({camId:l,pictureId:p.id}):await L.mutateAsync({camId:l,movieId:p.id}),a(`${s==="picture"||s==="pictures"?"Picture":"Movie"} deleted`,"success"),C(null),o?.id===p.id&&w(null)}catch{a("Failed to delete file","error")}},[p,i,l,$,L,a,o]),V=n.useCallback(()=>{C(null)},[]),W=n.useCallback((s,m)=>{A({path:s,fileCount:m})},[]),ae=n.useCallback(async()=>{if(j)try{const s=await F.mutateAsync({camId:l,path:j.path});a(`Deleted ${s.deleted.movies} movies, ${s.deleted.pictures} pictures`,"success"),A(null)}catch{a("Failed to delete folder contents","error")}},[j,l,F,a]),U=n.useCallback(()=>{A(null)},[]),z=n.useCallback(s=>{P(s),y(0)},[]),le=n.useCallback(()=>{u?.parent!==null&&(P(u?.parent??""),y(0))},[u]),S=$.isPending||L.isPending,_=F.isPending,G=d?d.split("/"):[];return e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsx("h2",{className:"text-3xl font-bold",children:"Media"})}),e.jsxs("div",{className:"flex flex-wrap gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"camera-select",className:"block text-sm font-medium mb-2",children:"Camera"}),e.jsx("select",{id:"camera-select",value:l,onChange:s=>v(parseInt(s.target.value)),className:"px-3 py-2 bg-surface border border-surface-elevated rounded-lg",children:Z?.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Type"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>b("pictures"),className:`px-4 py-2 rounded-lg transition-colors ${i==="pictures"?"bg-primary text-white":"bg-surface-elevated hover:bg-surface"}`,disabled:t==="folders",children:"Pictures"}),e.jsx("button",{onClick:()=>b("movies"),className:`px-4 py-2 rounded-lg transition-colors ${i==="movies"?"bg-primary text-white":"bg-surface-elevated hover:bg-surface"}`,disabled:t==="folders",children:"Movies"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"View"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>x("all"),className:`px-3 py-2 rounded-lg transition-colors text-sm ${t==="all"?"bg-primary text-white":"bg-surface-elevated hover:bg-surface"}`,children:"All"}),e.jsx("button",{onClick:()=>x("folders"),className:`px-3 py-2 rounded-lg transition-colors text-sm ${t==="folders"?"bg-primary text-white":"bg-surface-elevated hover:bg-surface"}`,children:"Folders"})]})]})]}),t==="folders"&&e.jsxs("div",{className:"mb-6 p-4 bg-surface-elevated rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("svg",{className:"w-5 h-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"})}),e.jsx("span",{className:"text-sm font-medium text-gray-300",children:"Browse Folders"})]}),e.jsxs("div",{className:"flex items-center gap-1 text-sm flex-wrap",children:[e.jsx("button",{onClick:()=>z(""),className:"hover:text-primary px-1",children:"Root"}),G.map((s,m)=>{const h=G.slice(0,m+1).join("/");return e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-gray-500",children:"/"}),e.jsx("button",{onClick:()=>z(h),className:"hover:text-primary px-1",children:s})]},m)})]}),u?.parent!==null&&e.jsxs("button",{onClick:le,className:"mt-2 flex items-center gap-2 text-sm text-gray-400 hover:text-white",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),"Up to parent folder"]})]}),t==="folders"&&u&&u.folders.length>0&&e.jsx("div",{className:"mb-6 grid gap-2 md:grid-cols-2 lg:grid-cols-4",children:u.folders.map(s=>e.jsxs("div",{className:"bg-surface-elevated rounded-lg p-4 hover:ring-2 hover:ring-primary cursor-pointer transition-all group",children:[e.jsx("button",{onClick:()=>z(s.path),className:"w-full text-left",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("svg",{className:"w-8 h-8 text-yellow-500 flex-shrink-0",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:s.name}),e.jsxs("p",{className:"text-xs text-gray-400",children:[s.file_count," files - ",I(s.total_size)]})]})]})}),f&&s.file_count>0&&e.jsx("button",{onClick:m=>{m.stopPropagation(),W(s.path,s.file_count)},className:"mt-2 w-full px-2 py-1 text-xs bg-red-600/20 text-red-400 hover:bg-red-600/40 rounded opacity-0 group-hover:opacity-100 transition-opacity",title:`Delete all ${s.file_count} media files in this folder`,children:"Delete All Media"})]},s.path))}),t==="folders"&&f&&d&&u&&u.total_files>0&&e.jsx("div",{className:"mb-4 flex justify-end",children:e.jsxs("button",{onClick:()=>W(d,u.total_files),className:"px-3 py-1.5 text-sm bg-red-600/20 text-red-400 hover:bg-red-600/40 rounded-lg flex items-center gap-2",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),"Delete All Media in This Folder (",u.total_files,")"]})}),!T&&D>0&&e.jsx(O,{offset:N,limit:g,total:D,onPageChange:s=>y(s/g),context:t==="folders"&&d?`in ${d}`:void 0}),T?e.jsx("div",{className:"grid gap-4 md:grid-cols-3 lg:grid-cols-4",children:[1,2,3,4,5,6,7,8].map(s=>e.jsxs("div",{className:"bg-surface-elevated rounded-lg animate-pulse",children:[e.jsx("div",{className:"aspect-video bg-surface rounded-t-lg"}),e.jsxs("div",{className:"p-3",children:[e.jsx("div",{className:"h-4 bg-surface rounded w-3/4 mb-2"}),e.jsx("div",{className:"h-3 bg-surface rounded w-1/2"})]})]},s))}):q.length===0?e.jsxs("div",{className:"bg-surface-elevated rounded-lg p-8 text-center",children:[e.jsx("p",{className:"text-gray-400",children:t==="folders"?"No media files in this folder":`No ${i} found`}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:t==="folders"?"Navigate to a folder with media files":i==="pictures"?"Motion detection snapshots will appear here":"Recorded videos will appear here"})]}):e.jsx("div",{className:"grid gap-4 md:grid-cols-3 lg:grid-cols-4",children:q.map(s=>{const m="type"in s?s.type:i==="pictures"?"picture":"movie",h=s.thumbnail||void 0;return e.jsxs("button",{className:"bg-surface-elevated rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-primary focus:ring-2 focus:ring-primary focus:outline-none transition-all group relative text-left w-full",onClick:()=>w(s),"aria-label":`View ${s.filename}`,children:[e.jsx("button",{onClick:M=>se(s,M),className:"absolute top-2 right-2 z-10 p-1.5 bg-red-600/80 hover:bg-red-600 rounded opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition-opacity",title:"Delete","aria-label":`Delete ${s.filename}`,children:e.jsx("svg",{className:"w-4 h-4 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})}),e.jsxs("div",{className:"aspect-video bg-surface flex items-center justify-center relative overflow-hidden",children:[m==="picture"?e.jsx("img",{src:k(s.path),alt:s.filename,className:"w-full h-full object-cover",loading:"lazy"}):h?e.jsx("img",{src:k(h),alt:s.filename,className:"w-full h-full object-cover",loading:"lazy",onError:M=>{M.currentTarget.style.display="none";const H=M.currentTarget.parentElement;if(H){const Q=H.querySelector(".fallback-icon");Q&&(Q.style.display="flex")}}}):null,e.jsx("div",{className:`fallback-icon text-gray-400 absolute inset-0 flex items-center justify-center ${h?"hidden":""}`,children:e.jsxs("svg",{className:"w-16 h-16",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})]})})]}),e.jsxs("div",{className:"p-3",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.filename}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-400 mt-1",children:[e.jsx("span",{children:I(s.size)}),e.jsx("span",{children:s.date?K(s.date,s.time):""})]})]})]},`${t}-${d}-${s.id}`)})}),!T&&D>0&&e.jsx(O,{offset:N,limit:g,total:D,onPageChange:s=>y(s/g),context:t==="folders"&&d?`in ${d}`:void 0}),o&&e.jsx("div",{className:"fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4",onClick:()=>w(null),children:e.jsxs("div",{className:"max-w-6xl w-full bg-surface-elevated rounded-lg overflow-hidden",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"p-4 border-b border-surface flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:o.filename}),e.jsxs("p",{className:"text-sm text-gray-400",children:[I(o.size)," ",o.date&&`- ${K(o.date,o.time)}`]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("a",{href:k(o.path),download:o.filename,className:"px-3 py-1 bg-primary hover:bg-primary-hover rounded text-sm",onClick:s=>s.stopPropagation(),children:"Download"}),e.jsx("button",{onClick:s=>{s.stopPropagation(),C(o)},className:"px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm",children:"Delete"}),e.jsx("button",{onClick:()=>w(null),className:"px-3 py-1 bg-surface hover:bg-surface-elevated rounded text-sm",children:"Close"})]})]}),e.jsx("div",{className:"p-4",children:("type"in o?o.type:i)==="picture"?e.jsx("img",{src:k(o.path),alt:o.filename,className:"w-full h-auto max-h-[70vh] object-contain"}):e.jsx("video",{src:k(o.path),controls:!0,className:"w-full h-auto max-h-[70vh]",autoPlay:!0,children:"Your browser does not support video playback."})})]})}),p&&e.jsx("div",{className:"fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4",onClick:V,children:e.jsx("div",{className:"w-full max-w-md bg-surface-elevated rounded-lg",onClick:s=>s.stopPropagation(),children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-xl font-bold mb-2",children:"Delete File?"}),e.jsxs("p",{className:"text-gray-400 mb-4",children:["Are you sure you want to delete ",e.jsx("span",{className:"font-medium text-white",children:p.filename}),"? This action cannot be undone."]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:V,disabled:S,className:"px-4 py-2 bg-surface hover:bg-surface-elevated rounded-lg disabled:opacity-50",children:"Cancel"}),e.jsx("button",{onClick:te,disabled:S,className:"px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg disabled:opacity-50",children:S?"Deleting...":"Delete"})]})]})})}),j&&e.jsx("div",{className:"fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4",onClick:U,children:e.jsx("div",{className:"w-full max-w-md bg-surface-elevated rounded-lg",onClick:s=>s.stopPropagation(),children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-xl font-bold mb-2 text-red-400",children:"Delete All Media Files?"}),e.jsxs("p",{className:"text-gray-400 mb-4",children:["Are you sure you want to delete ",e.jsxs("span",{className:"font-medium text-white",children:["all ",j.fileCount," media files"]})," in folder ",e.jsx("span",{className:"font-mono text-primary",children:j.path||"root"}),"?"]}),e.jsx("p",{className:"text-sm text-yellow-500 mb-4",children:"This will delete movies, pictures, and their thumbnails. Subfolders will NOT be deleted. This action cannot be undone."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:U,disabled:_,className:"px-4 py-2 bg-surface hover:bg-surface-elevated rounded-lg disabled:opacity-50",children:"Cancel"}),e.jsx("button",{onClick:ae,disabled:_,className:"px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg disabled:opacity-50",children:_?"Deleting...":"Delete All"})]})]})})})]})}export{be as Media};
